---
import BaseDashboard from '../../layouts/BaseDashboard.astro';
import Card from '../../components/ui/Card.astro';
import Button from '../../components/ui/Button.astro';
import Badge from '../../components/ui/Badge.astro';
import Loading from '../../components/ui/Loading.astro';
import CalendarioDisponibilidad from '../../components/dashboard/recepcionista/CalendarioDisponibilidad.astro';
---

<!-- Script de verificaci√≥n ANTES de renderizar contenido -->
<script is:inline>
  // Verificar autenticaci√≥n inmediatamente antes de mostrar la p√°gina
  (function() {
    const jwt = localStorage.getItem('jwt') || sessionStorage.getItem('jwt');
    const appUserStr = localStorage.getItem('appUser') || sessionStorage.getItem('appUser');
    
    if (!jwt || !appUserStr) {
      window.location.replace('/login');
      return;
    }
    
    try {
      const appUser = JSON.parse(appUserStr);
      const userRole = appUser?.usuario?.tipo_usuario?.toLowerCase();
      
      // Verificar que sea recepcionista
      if (userRole !== 'recepcionista') {
        window.location.replace(`/dashboard/${userRole}`);
        return;
      }
    } catch (error) {
      console.error('Error verificando sesi√≥n:', error);
      localStorage.clear();
      sessionStorage.clear();
      window.location.replace('/login');
    }
  })();
</script>

<BaseDashboard>

    <div class="flex flex-col lg:flex-row gap-4 mt-10">
      
      <!-- Panel Principal: Calendario + Gesti√≥n de Citas -->
      <div class="flex-1 space-y-4">
        
        <!-- Secci√≥n Calendario de Disponibilidad -->
        <Card padding="md">
          <div class="flex items-center gap-2 mb-4 pb-3 border-b border-gray-200">
            <span class="text-xl">üìÖ</span>
            <h2 class="text-lg font-bold text-gray-900">Agendar Cita</h2>
          </div>
          <CalendarioDisponibilidad />
        </Card>

        <!-- Secci√≥n Gesti√≥n de Citas -->
        <Card padding="md">
          <div class="flex items-center gap-2 mb-4 pb-3 border-b border-gray-200">
            <span class="text-xl">üìã</span>
            <h2 class="text-lg font-bold text-gray-900">Gesti√≥n de Citas</h2>
          </div>

          <!-- Filtros -->
          <div class="flex gap-2 flex-wrap mb-4">
            <button data-filter="todas" class="px-3 py-1.5 text-sm rounded-lg font-medium transition-colors bg-orange-500 text-white hover:bg-orange-600">
              Todas
            </button>
            <button data-filter="pendiente" class="px-3 py-1.5 text-sm rounded-lg font-medium transition-colors bg-gray-100 text-gray-700 hover:bg-gray-200">
              Pendientes
            </button>
            <button data-filter="confirmada" class="px-3 py-1.5 text-sm rounded-lg font-medium transition-colors bg-gray-100 text-gray-700 hover:bg-gray-200">
              Confirmadas
            </button>
            <button data-filter="cancelada" class="px-3 py-1.5 text-sm rounded-lg font-medium transition-colors bg-gray-100 text-gray-700 hover:bg-gray-200">
              Canceladas
            </button>
          </div>

          <!-- Lista de Citas -->
          <div id="citas-container" class="space-y-3">
            <Loading size="sm" text="Cargando citas..." />
          </div>
        </Card>
      </div>

      <!-- Panel Lateral: Notificaciones -->
      <aside class="w-full lg:w-80 shrink-0 order-first lg:order-last">
        
        <!-- Notificaciones del Sistema -->
        <Card padding="sm" class="sticky top-4">
          <div class="flex items-center gap-2 mb-3 pb-2 border-b border-gray-200">
            <span class="text-base">üîî</span>
            <h2 class="text-sm font-bold text-gray-900">Notificaciones</h2>
            <span id="badge-notificaciones" class="ml-auto bg-red-500 text-white text-xs font-bold px-2 py-0.5 rounded-full">0</span>
          </div>
          
          <div id="notificaciones-sistema-container" class="space-y-2 max-h-[200px] overflow-y-auto">
            <Loading size="sm" />
          </div>

          <button 
            id="btn-marcar-leidas"
            class="w-full mt-3 px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-700 text-xs font-medium rounded transition-colors"
            style="display: none;"
          >
            Marcar todas como le√≠das
          </button>
        </Card>
        
      </aside>

    </div>
  </div>
</BaseDashboard>

<script>
  import { loadSession } from '../../lib/authHelpers.js';
  import { CitasAPI } from '../../lib/api/citas.js';
  import { NotificacionesAPI } from '../../lib/api/notificaciones.js';

  let session, citasAPI, notificacionesAPI;
  let citasData = [];
  let notificacionesData = [];
  let filtroActual = 'todas';

  document.addEventListener('DOMContentLoaded', async () => {
    session = loadSession();
    if (!session?.jwt) {
      window.location.href = '/login';
      return;
    }

    citasAPI = new CitasAPI(session.jwt);
    notificacionesAPI = new NotificacionesAPI(session.jwt);
    document.getElementById('user-info').textContent = session.appUser.profile.email;

    await cargarDatos();
    setupEventos();
    
    // Recargar cada 10s para actualizaciones en tiempo real
    setInterval(async () => {
      console.log('üîÑ Actualizando datos autom√°ticamente...');
      await cargarDatos();
    }, 10000);

    // Escuchar cambios de visibilidad de la p√°gina
    document.addEventListener('visibilitychange', async () => {
      if (!document.hidden) {
        console.log('üëÅÔ∏è P√°gina visible - actualizando datos...');
        await cargarDatos();
      }
    });
  });

  async function cargarDatos() {
    await Promise.all([cargarCitas(), cargarNotificaciones()]);
  }

  async function cargarCitas() {
    try {
      citasData = await citasAPI.getMisCitas();
      renderCitas();
    } catch (error) {
      console.error('Error cargando citas:', error);
      document.getElementById('citas-container').innerHTML = `
        <div class="bg-red-50 border border-red-200 rounded-lg p-4">
          <p class="text-center text-red-600 text-sm font-medium">Error al cargar citas</p>
          <p class="text-center text-red-500 text-xs mt-1">${error.message}</p>
        </div>
      `;
    }
  }

  async function cargarNotificaciones() {
    try {
      notificacionesData = await notificacionesAPI.getMisNotificaciones();
      console.log('‚úÖ Notificaciones cargadas:', notificacionesData.length);
      renderNotificacionesSistema();
    } catch (error) {
      console.error('‚ùå Error cargando notificaciones:', error);
      // Mostrar mensaje solo si no es el primer intento (evita mostrar error en carga inicial)
      const container = document.getElementById('notificaciones-sistema-container');
      if (container && notificacionesData.length === 0) {
        container.innerHTML = `
          <p class="text-xs text-gray-500 text-center py-4">Sin notificaciones</p>
        `;
      }
    }
  }

  function renderCitas() {
    const container = document.getElementById('citas-container');
    let citasFiltradas = filtroActual === 'todas' 
      ? citasData 
      : citasData.filter(c => c.estado === filtroActual);

    // Ordenar por fecha y hora (m√°s pr√≥ximas primero)
    citasFiltradas = citasFiltradas.sort((a, b) => {
      const fechaA = new Date(a.fecha + 'T' + (a.hora || '00:00:00'));
      const fechaB = new Date(b.fecha + 'T' + (b.hora || '00:00:00'));
      return fechaA - fechaB;
    });

    if (citasFiltradas.length === 0) {
      container.innerHTML = `
        <div class="text-center py-8 text-gray-500 text-sm">
          No hay citas ${filtroActual === 'todas' ? '' : filtroActual + 's'}
        </div>
      `;
      return;
    }

    container.innerHTML = citasFiltradas.map(c => {
      const estadoClasses = {
        pendiente: 'bg-yellow-100 text-yellow-800 border-yellow-200',
        confirmada: 'bg-green-100 text-green-800 border-green-200',
        cancelada: 'bg-red-100 text-red-800 border-red-200'
      };
      
      const estadoTextos = {
        pendiente: 'Pendiente',
        confirmada: 'Confirmada',
        cancelada: 'Cancelada'
      };

      return `
        <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-4 transition-all" data-cita-id="${c.id}">
          <div class="flex items-start justify-between mb-3">
            <div class="flex-1">
              <div class="flex items-center gap-2 mb-1">
                <p class="font-semibold text-gray-900">${formatearFecha(c.fecha)} ‚Ä¢ ${c.hora?.substring(0, 5)}</p>
                <span class="inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium border ${estadoClasses[c.estado]}">
                  ${estadoTextos[c.estado]}
                </span>
              </div>
              
              <div class="text-sm text-gray-600 space-y-1">
                <p>üêæ ${c.paciente?.nombre || '(Sin mascota)'}</p>
                <p>üë§ ${c.paciente?.propietario?.nombreCompleto || c.paciente?.propietario?.username || c.paciente?.propietario?.email || '(Sin datos)'}</p>
                <p>üë®‚Äç‚öïÔ∏è Dr. ${c.veterinario?.nombreCompleto || c.veterinario?.username || 'N/A'}</p>
                ${c.motivo ? `<p class="text-xs text-gray-500 italic">üìù ${c.motivo}</p>` : ''}
              </div>
            </div>
          </div>

          ${c.estado === 'pendiente' ? `
            <div class="flex gap-2 pt-3 border-t border-gray-100">
              <button 
                onclick="confirmarCita('${c.documentId}')" 
                class="flex-1 px-3 py-2 bg-green-500 hover:bg-green-600 text-white text-sm font-medium rounded-lg transition-colors"
              >
                ‚úì Confirmar
              </button>
              <button 
                onclick="rechazarCita('${c.documentId}')" 
                class="flex-1 px-3 py-2 bg-red-500 hover:bg-red-600 text-white text-sm font-medium rounded-lg transition-colors"
              >
                ‚úó Rechazar
              </button>
            </div>
          ` : c.estado === 'confirmada' ? `
            <button 
              onclick="cancelarCita('${c.documentId}')" 
              class="w-full mt-3 px-3 py-2 bg-red-500 hover:bg-red-600 text-white text-sm font-medium rounded-lg transition-colors"
            >
              Cancelar
            </button>
          ` : ''}
        </div>
      `;
    }).join('');
  }

  function renderNotificacionesSistema() {
    const container = document.getElementById('notificaciones-sistema-container');
    const noLeidas = notificacionesData.filter(n => !n.leida);
    
    document.getElementById('badge-notificaciones').textContent = noLeidas.length;

    const btnMarcarLeidas = document.getElementById('btn-marcar-leidas');
    if (noLeidas.length > 0) {
      btnMarcarLeidas.style.display = 'block';
    } else {
      btnMarcarLeidas.style.display = 'none';
    }

    if (notificacionesData.length === 0) {
      container.innerHTML = '<p class="text-xs text-gray-500 text-center py-4">Sin notificaciones</p>';
      return;
    }

    const iconosPorTipo = {
      'cancelacion': 'üö´',
      'recordatorio': '‚è∞',
      'general': 'üîî',
      'confirmacion': '‚úÖ',
      'default': 'üìã'
    };

    container.innerHTML = notificacionesData.slice(0, 15).map(n => {
      const icono = iconosPorTipo[n.tipo] || iconosPorTipo.default;
      const bgClass = n.leida ? 'bg-gray-50 border-gray-200' : 'bg-blue-50 border-blue-200';
      const fontClass = n.leida ? 'text-gray-600' : 'text-gray-900 font-medium';

      const fechaFormateada = new Date(n.fecha_notificacion).toLocaleDateString('es-CL', {
        day: '2-digit',
        month: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      });

      // Obtener ID de cita relacionada si existe
      const citaId = n.cita_relacionada?.id || null;
      const clickHandler = citaId 
        ? `onclick="scrollYMarcarLeida(${n.id}, ${citaId})"`
        : `onclick="marcarNotificacionLeida(${n.id})"`;

      return `
        <div 
          class="${bgClass} border rounded-lg p-3 text-xs hover:shadow-sm transition-shadow cursor-pointer"
          ${clickHandler}
        >
          <div class="flex items-start gap-2">
            <span class="text-base">${icono}</span>
            <div class="flex-1">
              <p class="${fontClass} text-xs font-semibold mb-1">${n.titulo || 'Notificaci√≥n'}</p>
              <p class="text-gray-700 text-xs mb-1">${n.mensaje}</p>
              <p class="text-gray-500 text-xs">${fechaFormateada}</p>
            </div>
          </div>
        </div>
      `;
    }).join('');
  }

  function setupEventos() {
    document.querySelectorAll('[data-filter]').forEach(btn => {
      btn.addEventListener('click', () => {
        console.log('üîò Filtro clickeado:', btn.dataset.filter);
        
        // Remover estilo activo de todos los botones
        document.querySelectorAll('[data-filter]').forEach(b => {
          b.classList.remove('bg-orange-500', 'text-white', 'hover:bg-orange-600');
          b.classList.add('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');
        });
        
        // Aplicar estilo activo al bot√≥n clickeado
        btn.classList.remove('bg-gray-100', 'text-gray-700', 'hover:bg-gray-200');
        btn.classList.add('bg-orange-500', 'text-white', 'hover:bg-orange-600');
        
        filtroActual = btn.dataset.filter;
        console.log('üõ†Ô∏è Filtro aplicado:', filtroActual);
        renderCitas();
      });
    });

    // Bot√≥n marcar todas como le√≠das
    document.getElementById('btn-marcar-leidas').addEventListener('click', async () => {
      try {
        await notificacionesAPI.marcarTodasLeidas();
        await cargarNotificaciones();
      } catch (error) {
        console.error('Error marcando notificaciones:', error);
      }
    });
  }

  window.marcarNotificacionLeida = async (notificacionId) => {
    try {
      await notificacionesAPI.marcarLeida(notificacionId);
      await cargarNotificaciones();
    } catch (error) {
      console.error('Error marcando notificaci√≥n:', error);
    }
  };

  window.scrollYMarcarLeida = async (notificacionId, citaId) => {
    console.log('üéØ scrollYMarcarLeida llamado con:', { notificacionId, citaId });
    
    // Marcar como le√≠da
    try {
      await notificacionesAPI.marcarLeida(notificacionId);
      await cargarNotificaciones();
    } catch (error) {
      console.error('Error marcando notificaci√≥n:', error);
    }

    console.log('üìä citasData disponible:', citasData);
    
    // Buscar la cita por ID en el array de datos
    const cita = citasData.find(c => c.id === citaId);
    console.log('üîç Cita encontrada:', cita);
    
    if (!cita) {
      console.log('‚ùå Cita no encontrada en los datos actuales');
      return;
    }

    // Buscar el elemento en el DOM por data-cita-id
    setTimeout(() => {
      const citaElemento = document.querySelector(`[data-cita-id="${citaId}"]`);
      console.log('üé® Elemento DOM encontrado:', citaElemento);
      
      if (citaElemento) {
        console.log('‚úÖ Haciendo scroll al elemento');
        citaElemento.scrollIntoView({ behavior: 'smooth', block: 'center' });
        // Destacar brevemente la cita
        citaElemento.classList.add('ring-4', 'ring-orange-300', 'ring-offset-2');
        setTimeout(() => {
          citaElemento.classList.remove('ring-4', 'ring-orange-300', 'ring-offset-2');
        }, 2500);
      } else {
        console.log('‚ö†Ô∏è Elemento no visible, intentando cambiar filtro');
        // Si no est√° visible, cambiar filtro para mostrarla
        const filtroBtn = document.querySelector(`[data-filter="${cita.estado}"]`);
        console.log('üîò Bot√≥n filtro encontrado:', filtroBtn, 'para estado:', cita.estado);
        
        if (filtroBtn) {
          filtroBtn.click();
          setTimeout(() => {
            const elem = document.querySelector(`[data-cita-id="${citaId}"]`);
            console.log('üîÑ Elemento despu√©s de cambiar filtro:', elem);
            
            if (elem) {
              elem.scrollIntoView({ behavior: 'smooth', block: 'center' });
              elem.classList.add('ring-4', 'ring-orange-300', 'ring-offset-2');
              setTimeout(() => {
                elem.classList.remove('ring-4', 'ring-orange-300', 'ring-offset-2');
              }, 2500);
            }
          }, 300);
        }
      }
    }, 100);
  };

  window.confirmarCita = async (documentId) => {
    if (!confirm('¬øConfirmar esta cita?')) return;
    
    try {
      await citasAPI.confirmarCita(documentId);
      await cargarCitas();
      alert('‚úÖ Cita confirmada');
    } catch (error) {
      console.error('Error confirmando cita:', error);
      alert('‚ùå Error: ' + error.message);
    }
  };

  window.rechazarCita = async (documentId) => {
    if (!confirm('¬øRechazar esta cita?')) return;
    
    try {
      await citasAPI.cancelarCita(documentId);
      await cargarCitas();
      alert('‚ùå Cita rechazada');
    } catch (error) {
      console.error('Error rechazando cita:', error);
      alert('‚ùå Error: ' + error.message);
    }
  };

  window.cancelarCita = async (documentId) => {
    if (!confirm('¬øCancelar esta cita?')) return;
    
    try {
      await citasAPI.cancelarCita(documentId);
      await cargarCitas();
      alert('üö´ Cita cancelada');
    } catch (error) {
      console.error('Error cancelando cita:', error);
      alert('‚ùå Error: ' + error.message);
    }
  };

  window.scrollToCita = (id) => {
    const filtroBtn = document.querySelector('[data-filter="pendiente"]');
    if (filtroBtn) filtroBtn.click();
    setTimeout(() => {
      window.scrollTo({ top: 200, behavior: 'smooth' });
    }, 100);
  };

  function formatearFecha(fecha) {
    return new Date(fecha + 'T00:00:00').toLocaleDateString('es-CL', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric'
    });
  }
</script>

<script type="module">
  import { requireRole } from "/src/lib/authHelpers.js";
  
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', async () => {
      console.log("DOM listo, ejecutando requireRole para recepcionista");
      await requireRole(["recepcionista"]);
    });
  } else {
    console.log("DOM ya listo, ejecutando requireRole para recepcionista");
    await requireRole(["recepcionista"]);
  }
</script>

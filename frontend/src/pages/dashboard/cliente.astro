---
import BaseDashboard from '../../layouts/BaseDashboard.astro';
import Card from '../../components/ui/Card.astro';
import Button from '../../components/ui/Button.astro';
import Modal from '../../components/ui/Modal.astro';
import Input from '../../components/ui/Input.astro';
import Select from '../../components/ui/Select.astro';
import Loading from '../../components/ui/Loading.astro';
---

<BaseDashboard>
  <div class="max-w-6xl mx-auto p-4 space-y-6">
    
    <!-- Header -->
    <div class="flex items-center justify-between">
      <h1 class="text-2xl font-bold text-gray-900">Mi Panel</h1>
      <div class="text-sm text-gray-600" id="user-info">Cargando...</div>
    </div>

    <!-- Mis Mascotas -->
    <section>
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-lg font-semibold text-gray-900 flex items-center gap-2">
          <span>üêæ</span>
          <span>Mis Mascotas</span>
        </h2>
        <button onclick="window.open_modal_nueva_mascota()" class="px-3 py-1.5 text-sm bg-orange-500 hover:bg-orange-600 text-white rounded-lg font-medium transition-colors">
          + Agregar Mascota
        </button>
      </div>

      <div id="mascotas-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <Card padding="md">
          <Loading size="sm" text="Cargando mascotas..." />
        </Card>
      </div>
    </section>

    <!-- Solicitar Cita -->
    <section>
      <Card padding="lg">
        <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
          <span>üìÖ</span>
          <span>Solicitar Cita</span>
        </h2>

        <form id="form-solicitar-cita" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Mascota</label>
              <Select id="select-mascota" name="mascota" required>
                <option value="">Selecciona una mascota</option>
              </Select>
            </div>

            <div>
              <label class="block text-sm font-medium text-gray-700 mb-1">Veterinario</label>
              <Select id="select-veterinario" name="veterinario" required>
                <option value="">Selecciona un veterinario</option>
              </Select>
            </div>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Fecha y Hora</label>
            <button type="button" onclick="abrirSelectorDisponibilidad()" class="px-3 py-1.5 text-sm bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg font-medium transition-colors">
              Ver Disponibilidad
            </button>
            <input type="hidden" id="disponibilidad-seleccionada" name="disponibilidad" />
            <p id="disponibilidad-texto" class="text-sm text-gray-600 mt-2">No has seleccionado horario</p>
          </div>

          <div>
            <label class="block text-sm font-medium text-gray-700 mb-1">Motivo (opcional)</label>
            <textarea 
              id="motivo" 
              name="motivo" 
              rows="3"
              class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent"
              placeholder="Describe brevemente el motivo de la consulta..."
            ></textarea>
          </div>

          <Button type="submit" variant="primary" size="md" full>
            Solicitar Cita
          </Button>
        </form>
      </Card>
    </section>

    <!-- Mis Citas -->
    <section>
      <h2 class="text-lg font-semibold text-gray-900 mb-4 flex items-center gap-2">
        <span>üìã</span>
        <span>Mis Citas</span>
      </h2>

      <div class="flex gap-2 mb-4 overflow-x-auto pb-2">
        <Button size="sm" variant="primary" data-filter="todas">Todas</Button>
        <Button size="sm" variant="ghost" data-filter="pendiente">Pendientes</Button>
        <Button size="sm" variant="ghost" data-filter="confirmada">Confirmadas</Button>
        <Button size="sm" variant="ghost" data-filter="cancelada">Canceladas</Button>
      </div>

      <div id="citas-container" class="space-y-3">
        <Card padding="md">
          <Loading size="sm" text="Cargando citas..." />
        </Card>
      </div>
    </section>

  </div>

  <!-- Modal: Nueva Mascota -->
  <Modal id="modal_nueva_mascota" title="Agregar Mascota" size="md">
    <form id="form-nueva-mascota" class="space-y-4">
      <div>
        <label class="block text-sm font-medium text-gray-700 mb-1">Nombre *</label>
        <Input type="text" name="nombre" placeholder="Ej: Firulais" required />
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Especie *</label>
          <Select name="especie" required>
            <option value="">Selecciona</option>
            <option value="Perro">Perro</option>
            <option value="Gato">Gato</option>
            <option value="Ave">Ave</option>
            <option value="Conejo">Conejo</option>
            <option value="Roedor">Roedor</option>
            <option value="Reptil">Reptil</option>
            <option value="Otro">Otro</option>
          </Select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Raza</label>
          <Input type="text" name="raza" placeholder="Ej: Labrador" />
        </div>
      </div>

      <div class="grid grid-cols-2 gap-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Sexo</label>
          <Select name="sexo">
            <option value="">Selecciona</option>
            <option value="Macho">Macho</option>
            <option value="Hembra">Hembra</option>
            <option value="Sin determinar">Sin determinar</option>
          </Select>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Fecha Nacimiento</label>
          <Input type="date" name="fecha_nacimiento" />
        </div>
      </div>

      <div class="flex gap-3 justify-end pt-4 border-t">
        <button type="button" onclick="window.close_modal_nueva_mascota()" class="px-4 py-2 text-sm bg-gray-200 hover:bg-gray-300 text-gray-800 rounded-lg font-medium transition-colors">
          Cancelar
        </button>
        <Button type="submit" variant="primary">
          Guardar Mascota
        </Button>
      </div>
    </form>
  </Modal>

  <!-- Modal: Seleccionar Disponibilidad -->
  <Modal id="modal_disponibilidad" title="Seleccionar Fecha y Hora" size="lg">
    <div id="disponibilidad-content">
      <Loading text="Cargando disponibilidad..." />
    </div>
  </Modal>

</BaseDashboard>

<script>
  import { loadSession } from '../../lib/authHelpers.js';
  import { PacientesAPI } from '../../lib/api/pacientes.js';
  import { CitasAPI } from '../../lib/api/citas.js';
  import { DisponibilidadesAPI } from '../../lib/api/disponibilidades.js';

  let session, pacientesAPI, citasAPI, disponibilidadesAPI;
  let mascotasData = [];
  let citasData = [];
  let filtroActual = 'todas';

  // Inicializar
  document.addEventListener('DOMContentLoaded', async () => {
    console.log('üöÄ Dashboard cliente iniciando...');
    
    session = loadSession();
    if (!session?.jwt) {
      console.error('‚ùå No hay sesi√≥n, redirigiendo a login');
      window.location.href = '/login';
      return;
    }

    console.log('‚úÖ Sesi√≥n cargada:', session.appUser.profile.email);

    pacientesAPI = new PacientesAPI(session.jwt);
    citasAPI = new CitasAPI(session.jwt);
    disponibilidadesAPI = new DisponibilidadesAPI(session.jwt);

    // Mostrar info usuario
    document.getElementById('user-info').textContent = session.appUser.profile.email;

    // Cargar datos
    console.log('üì• Cargando datos iniciales...');
    await Promise.all([
      cargarMascotas(),
      cargarCitas(),
      cargarVeterinarios()
    ]);

    // Eventos
    setupEventos();
    console.log('‚úÖ Dashboard cliente listo');
  });

  async function cargarMascotas() {
    try {
      mascotasData = await pacientesAPI.getMisPacientes();
      renderMascotas();
      actualizarSelectMascotas();
    } catch (error) {
      console.error('Error cargando mascotas:', error);
      document.getElementById('mascotas-container').innerHTML = `
        <div class="col-span-full text-center text-red-600 text-sm">${error.message}</div>
      `;
    }
  }

  function renderMascotas() {
    const container = document.getElementById('mascotas-container');
    
    if (mascotasData.length === 0) {
      container.innerHTML = `
        <div class="col-span-full text-center py-8 text-gray-500 text-sm">
          <p class="mb-2">No tienes mascotas registradas</p>
          <button onclick="window.open_modal_nueva_mascota()" class="text-orange-500 hover:underline">
            Agregar tu primera mascota
          </button>
        </div>
      `;
      return;
    }

    container.innerHTML = mascotasData.map(m => `
      <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-4 hover:shadow-md transition-shadow">
        <div class="flex items-start justify-between mb-3">
          <div>
            <h3 class="font-semibold text-gray-900">${m.nombre}</h3>
            <p class="text-sm text-gray-600">${m.especie}${m.raza ? ` ‚Ä¢ ${m.raza}` : ''}</p>
          </div>
          <span class="text-2xl">${getEmojiEspecie(m.especie)}</span>
        </div>
        ${m.sexo ? `<p class="text-xs text-gray-500">Sexo: ${m.sexo}</p>` : ''}
        ${m.fecha_nacimiento ? `<p class="text-xs text-gray-500">Naci√≥: ${formatearFecha(m.fecha_nacimiento)}</p>` : ''}
      </div>
    `).join('');
  }

  function actualizarSelectMascotas() {
    const select = document.getElementById('select-mascota');
    select.innerHTML = '<option value="">Selecciona una mascota</option>' +
      mascotasData.map(m => `<option value="${m.id}">${m.nombre} (${m.especie})</option>`).join('');
  }

  async function cargarCitas() {
    try {
      citasData = await citasAPI.getMisCitas();
      renderCitas();
    } catch (error) {
      console.error('Error cargando citas:', error);
      document.getElementById('citas-container').innerHTML = `
        <div class="text-center text-red-600 text-sm">${error.message}</div>
      `;
    }
  }

  function renderCitas() {
    const container = document.getElementById('citas-container');
    const citasFiltradas = filtroActual === 'todas' 
      ? citasData 
      : citasData.filter(c => c.estado === filtroActual);

    if (citasFiltradas.length === 0) {
      container.innerHTML = `
        <div class="text-center py-8 text-gray-500 text-sm">
          No tienes citas ${filtroActual === 'todas' ? '' : filtroActual + 's'}
        </div>
      `;
      return;
    }

    container.innerHTML = citasFiltradas.map(c => {
      const badgeVariant = c.estado === 'pendiente' ? 'pending' : c.estado === 'confirmada' ? 'confirmed' : 'canceled';
      const estadoTexto = c.estado === 'pendiente' ? 'Pendiente' : c.estado === 'confirmada' ? 'Confirmada' : 'Cancelada';
      
      return `
        <div class="bg-white rounded-lg shadow-sm border border-gray-100 p-4">
          <div class="flex items-start justify-between mb-2">
            <div>
              <p class="font-semibold text-gray-900">${formatearFecha(c.fecha)} ‚Ä¢ ${c.hora?.substring(0, 5)}</p>
              <p class="text-sm text-gray-600">${c.paciente?.nombre || 'Sin mascota'}</p>
            </div>
            <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium ${
              badgeVariant === 'pending' ? 'bg-yellow-100 text-yellow-800' :
              badgeVariant === 'confirmed' ? 'bg-green-100 text-green-800' :
              'bg-red-100 text-red-800'
            }">${estadoTexto}</span>
          </div>
          <p class="text-sm text-gray-600">Dr. ${c.veterinario?.nombreCompleto || c.veterinario?.username || 'N/A'}</p>
          ${c.motivo ? `<p class="text-xs text-gray-500 mt-2">${c.motivo}</p>` : ''}
          ${c.estado === 'pendiente' ? `
            <button onclick="cancelarCita('${c.documentId}')" class="mt-3 text-sm text-red-600 hover:underline">
              Cancelar cita
            </button>
          ` : ''}
        </div>
      `;
    }).join('');
  }

  async function cargarVeterinarios() {
    try {
      const veterinarios = await disponibilidadesAPI.getVeterinarios();
      const select = document.getElementById('select-veterinario');
      select.innerHTML = '<option value="">Selecciona un veterinario</option>' +
        veterinarios.map(v => `
          <option value="${v.id}">Dr. ${v.nombreCompleto || v.username}</option>
        `).join('');
    } catch (error) {
      console.error('Error cargando veterinarios:', error);
    }
  }

  function setupEventos() {
    console.log('‚öôÔ∏è Configurando event listeners...');
    
    // Form nueva mascota
    document.getElementById('form-nueva-mascota').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const datos = Object.fromEntries(formData);

      console.log('Creando mascota con datos:', datos);

      try {
        await pacientesAPI.crearPaciente(datos);
        window.close_modal_nueva_mascota();
        e.target.reset();
        await cargarMascotas();
        alert('‚úÖ Mascota registrada exitosamente');
      } catch (error) {
        alert('‚ùå Error: ' + error.message);
      }
    });

    // Form solicitar cita
    document.getElementById('form-solicitar-cita').addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      
      const disponibilidadId = document.getElementById('disponibilidad-seleccionada').value;
      if (!disponibilidadId) {
        alert('Selecciona una fecha y hora disponible');
        return;
      }

      const disponibilidad = JSON.parse(disponibilidadId);
      
      console.log('Solicitando cita con datos:', {
        pacienteId: parseInt(formData.get('mascota')),
        veterinarioId: parseInt(formData.get('veterinario')),
        fecha: disponibilidad.fecha,
        hora: disponibilidad.hora_inicio,
        motivo: formData.get('motivo') || '',
        disponibilidadId: disponibilidad.id
      });
      
      try {
        await citasAPI.solicitarCita({
          pacienteId: parseInt(formData.get('mascota')),
          veterinarioId: parseInt(formData.get('veterinario')),
          fecha: disponibilidad.fecha,
          hora: disponibilidad.hora_inicio,
          motivo: formData.get('motivo') || '',
          disponibilidadId: disponibilidad.id
        });

        e.target.reset();
        document.getElementById('disponibilidad-seleccionada').value = '';
        document.getElementById('disponibilidad-texto').textContent = 'No has seleccionado horario';
        await cargarCitas();
        alert('‚úÖ Cita solicitada exitosamente');
      } catch (error) {
        alert('‚ùå Error: ' + error.message);
      }
    });

    // Filtros de citas
    // Filtros de citas
    document.querySelectorAll('[data-filter]').forEach(btn => {
      btn.addEventListener('click', () => {
        // Remover estilo activo de todos los botones
        document.querySelectorAll('[data-filter]').forEach(b => {
          b.classList.remove('bg-orange-500', 'text-white', 'hover:bg-orange-600');
          b.classList.add('bg-transparent', 'text-gray-700', 'hover:bg-gray-100');
        });
        
        // Aplicar estilo activo al bot√≥n clickeado
        btn.classList.remove('bg-transparent', 'text-gray-700', 'hover:bg-gray-100');
        btn.classList.add('bg-orange-500', 'text-white', 'hover:bg-orange-600');
        
        filtroActual = btn.dataset.filter;
        console.log('üõ†Ô∏è Filtro cambiado a:', filtroActual);
        renderCitas();
      });
    });
  }

  window.abrirSelectorDisponibilidad = async () => {
    const veterinarioId = document.getElementById('select-veterinario').value;
    if (!veterinarioId) {
      alert('Selecciona un veterinario primero');
      return;
    }

    console.log('üîç Ver disponibilidad para veterinario:', veterinarioId);

    window.open_modal_disponibilidad();
    document.getElementById('disponibilidad-content').innerHTML = '<div class="flex justify-center py-8"><div class="text-sm text-gray-600">Cargando disponibilidad...</div></div>';
    
    try {
      const hoy = new Date();
      const mes = hoy.getMonth() + 1;
      const anio = hoy.getFullYear();
      
      // Buscar disponibilidades en los pr√≥ximos 3 meses
      const mesesBuscar = [];
      for (let i = 0; i < 3; i++) {
        const fecha = new Date(anio, mes - 1 + i, 1);
        mesesBuscar.push({
          mes: fecha.getMonth() + 1,
          anio: fecha.getFullYear()
        });
      }
      
      console.log('üìÖ Buscando disponibilidades en:', mesesBuscar);
      
      const todasDisponibilidades = [];
      for (const periodo of mesesBuscar) {
        const disps = await disponibilidadesAPI.getDisponibilidadesMes(
          periodo.mes,
          periodo.anio,
          parseInt(veterinarioId)
        );
        todasDisponibilidades.push(...disps);
      }
      
      console.log('‚úÖ Disponibilidades obtenidas:', todasDisponibilidades);
      
      // Filtrar solo disponibilidades futuras (fecha y hora)
      const ahora = new Date();
      const disponibilidadesFuturas = todasDisponibilidades.filter(d => {
        const fechaHora = new Date(`${d.fecha}T${d.hora_inicio}`);
        return fechaHora > ahora;
      });
      
      console.log('üìÖ Disponibilidades futuras filtradas:', disponibilidadesFuturas);
      
      mostrarDisponibilidades(disponibilidadesFuturas);
    } catch (error) {
      console.error('‚ùå Error cargando disponibilidades:', error);
      document.getElementById('disponibilidad-content').innerHTML = `
        <div class="text-center text-red-600 text-sm">${error.message}</div>
      `;
    }
  };

  function mostrarDisponibilidades(disponibilidades) {
    const container = document.getElementById('disponibilidad-content');
    
    if (disponibilidades.length === 0) {
      container.innerHTML = '<p class="text-sm text-gray-600 text-center py-8">No hay disponibilidad para este veterinario</p>';
      return;
    }

    // Guardar disponibilidades en variable global
    window.disponibilidadesActuales = disponibilidades;

    // Agrupar por fecha
    const porFecha = {};
    disponibilidades.forEach((d, index) => {
      if (!porFecha[d.fecha]) porFecha[d.fecha] = [];
      porFecha[d.fecha].push({ ...d, index });
    });

    container.innerHTML = Object.keys(porFecha).sort().map(fecha => `
      <div class="mb-4">
        <h4 class="font-semibold text-gray-900 mb-2">${formatearFecha(fecha)}</h4>
        <div class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-2">
          ${porFecha[fecha].map(d => `
            <button
              onclick="seleccionarDisponibilidad(${d.index})"
              class="px-3 py-2 text-sm bg-orange-50 text-orange-700 border border-orange-200 rounded-lg hover:bg-orange-100 transition-colors"
            >
              ${d.hora_inicio.substring(0, 5)}
            </button>
          `).join('')}
        </div>
      </div>
    `).join('');
  }

  window.seleccionarDisponibilidad = (index) => {
    const disp = window.disponibilidadesActuales[index];
    document.getElementById('disponibilidad-seleccionada').value = JSON.stringify(disp);
    document.getElementById('disponibilidad-texto').textContent = 
      `${formatearFecha(disp.fecha)} a las ${disp.hora_inicio.substring(0, 5)}`;
    window.close_modal_disponibilidad();
  };

  window.cancelarCita = async (documentId) => {
    if (!confirm('¬øSeguro que deseas cancelar esta cita?')) return;
    
    try {
      await citasAPI.cancelarCita(documentId);
      await cargarCitas();
      alert('‚úÖ Cita cancelada');
    } catch (error) {
      console.error('Error cancelando cita:', error);
      alert('‚ùå Error: ' + error.message);
    }
  };

  // Utilidades
  function getEmojiEspecie(especie) {
    const emojis = {
      'Perro': 'üêï',
      'Gato': 'üêà',
      'Ave': 'üê¶',
      'Conejo': 'üê∞',
      'Roedor': 'üêπ',
      'Reptil': 'ü¶é',
      'Otro': 'üêæ'
    };
    return emojis[especie] || 'üêæ';
  }

  function formatearFecha(fecha) {
    return new Date(fecha + 'T00:00:00').toLocaleDateString('es-CL', {
      day: '2-digit',
      month: '2-digit',
      year: 'numeric'
    });
  }
</script>

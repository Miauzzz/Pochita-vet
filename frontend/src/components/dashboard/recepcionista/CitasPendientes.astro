---
---

<div class="notificaciones-citas bg-gradient-to-br from-orange-50 to-white rounded-xl shadow-lg p-4 border-2 border-orange-300 max-h-[350px] lg:max-h-[500px] flex flex-col">
  <div class="flex items-center gap-2 mb-3 pb-2 border-b-2 border-orange-200">
    <span class="text-lg animate-pulse">ğŸ””</span>
    <h2 class="text-base font-bold text-gray-900">Notificaciones</h2>
    <span id="badge-count" class="ml-auto bg-orange-500 text-white text-xs font-bold px-2 py-0.5 rounded-full">0</span>
  </div>
  
  <div id="notif-container" class="flex-1 overflow-y-auto pr-1 space-y-2">
    <p class="text-gray-500 text-center py-4 text-xs">Cargando...</p>
  </div>
</div>

<script>
  import { loadSession } from '../../../lib/authHelpers.js';

  const STRAPI_URL = 'http://localhost:1337';

  async function cargarNotificaciones() {
    const session = loadSession();
    const jwt = session?.jwt;

    if (!jwt) {
      console.error('No hay JWT');
      return;
    }

    try {
      console.log('ğŸ”” Cargando notificaciones...');
      
      const response = await fetch(`${STRAPI_URL}/api/citas?populate=*&filters[estado][$eq]=pendiente&sort[0]=fecha:asc`, {
        headers: {
          'Authorization': `Bearer ${jwt}`,
          'Content-Type': 'application/json',
        },
      });

      if (!response.ok) {
        throw new Error(`Error ${response.status}: ${response.statusText}`);
      }

      const data = await response.json();
      console.log('âœ… Notificaciones recibidas:', data.data.length);
      if (data.data.length > 0) {
        console.log('ğŸ DEBUG NOTIF - Cita completa:', data.data[0]);
        console.log('ğŸ DEBUG NOTIF - Paciente:', data.data[0].paciente);
        console.log('ğŸ DEBUG NOTIF - Propietario:', data.data[0].paciente?.propietario);
      }
      
      mostrarNotificaciones(data.data);
    } catch (error: any) {
      console.error('âŒ Error:', error);
      const container = document.getElementById('notif-container');
      if (container) {
        container.innerHTML = '<p class="text-red-600 text-xs text-center py-2">Error al cargar</p>';
      }
    }
  }

  function mostrarNotificaciones(citas: any[]) {
    const container = document.getElementById('notif-container')!;
    const badge = document.getElementById('badge-count')!;
    
    badge.textContent = citas.length.toString();
    
    if (citas.length === 0) {
      container.innerHTML = '<p class="text-gray-500 text-center py-4 text-xs">No hay citas pendientes</p>';
      return;
    }

    const html = citas.slice(0, 8).map(cita => {
      const paciente = cita.paciente?.nombre || '(Sin paciente)';
      const propietario = cita.paciente?.propietario?.nombreCompleto || cita.paciente?.propietario?.username || '';
      const horaFormateada = cita.hora?.substring(0, 5) || '';
      
      return `
        <div class="bg-white border-l-3 border-l-yellow-500 rounded-md p-2 shadow-sm hover:shadow transition-shadow cursor-pointer" onclick="document.getElementById('gestion-citas-container')?.scrollIntoView({behavior: 'smooth'})">
          <p class="text-xs font-semibold text-gray-900">ğŸ¾ ${paciente}</p>
          ${propietario ? `<p class="text-xs text-gray-600">ğŸ‘¤ ${propietario}</p>` : ''}
          <p class="text-xs text-gray-500 mt-0.5">${cita.fecha} â€¢ ${horaFormateada}</p>
        </div>
      `;
    }).join('');
    
    container.innerHTML = html + (citas.length > 8 ? `<p class="text-xs text-gray-500 text-center mt-2">+${citas.length - 8} mÃ¡s...</p>` : '');
  }

  // Cargar al iniciar
  document.addEventListener('DOMContentLoaded', () => {
    cargarNotificaciones();
    
    // Recargar cada 30 segundos
    setInterval(cargarNotificaciones, 30000);
  });
</script>

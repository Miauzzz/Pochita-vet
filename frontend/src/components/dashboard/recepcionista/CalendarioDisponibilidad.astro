---
interface Props {
  veterinarioId?: number | null;
}

const { veterinarioId = null } = Astro.props;
---

<div class="calendario-container" x-data="calendarioDisponibilidad()">
  <!-- Selector de mes -->
  <div class="calendario-header">
    <button @click="mesAnterior()" class="btn-nav" title="Mes anterior">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="15 18 9 12 15 6"></polyline>
      </svg>
    </button>
    <h3 class="mes-titulo" x-text="nombreMes + ' ' + anio"></h3>
    <button @click="mesSiguiente()" class="btn-nav" title="Mes siguiente">
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <polyline points="9 18 15 12 9 6"></polyline>
      </svg>
    </button>
  </div>

  <!-- D√≠as de la semana -->
  <div class="calendario-dias-semana">
    <div>Lun</div>
    <div>Mar</div>
    <div>Mi√©</div>
    <div>Jue</div>
    <div>Vie</div>
    <div>S√°b</div>
    <div>Dom</div>
  </div>

  <!-- D√≠as del mes -->
  <div class="calendario-dias">
    <!-- Espacios vac√≠os antes del primer d√≠a -->
    <template x-for="i in diasVaciosInicio" :key="'vacio-' + i">
      <div class="dia-vacio"></div>
    </template>
    
    <!-- D√≠as del mes -->
    <template x-for="dia in diasMes" :key="dia.fecha">
      <div 
        class="dia"
        x-bind:class="getClass(dia)"
        @click="seleccionarDia(dia)"
      >
        <span class="numero-dia" x-text="dia.numero"></span>
        <template x-if="dia.tieneDisponibilidad">
          <div class="indicadores">
            <span 
              x-show="dia.cantidadDisponible > 0" 
              class="badge badge-disponible"
              x-text="dia.cantidadDisponible"
              title="Bloques disponibles"
            ></span>
            <span 
              x-show="dia.cantidadOcupado > 0" 
              class="badge badge-ocupado"
              x-text="dia.cantidadOcupado"
              title="Bloques ocupados"
            ></span>
          </div>
        </template>
      </div>
    </template>
  </div>

  <!-- Filtro: seleccionar veterinario -->
  <div class="mb-4 flex items-center gap-3">
    <label class="text-sm font-medium text-gray-700">Filtrar por veterinario:</label>
    <select x-model="veterinarioSeleccionado" @change="onChangeVeterinario()" class="px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-orange-500 focus:border-transparent">
      <option value="">Todos los veterinarios</option>
      <template x-for="v in veterinarios" :key="v.id">
        <option :value="v.id" x-text="v.nombreCompleto ? 'Dr. ' + v.nombreCompleto : v.username"></option>
      </template>
    </select>
  </div>

  <!-- Info del d√≠a seleccionado -->
  <div x-show="diaSeleccionado" class="info-dia" x-transition>
    <div class="info-dia-header">
      <h4>üìÖ <span x-text="formatearFecha(diaSeleccionado?.fecha)"></span></h4>
      <button @click="cerrarDetalle()" class="btn-cerrar" title="Cerrar">√ó</button>
    </div>
    
    <div class="bloques-container">
      <template x-if="!diaSeleccionado?.bloques || diaSeleccionado.bloques.length === 0">
        <p class="sin-bloques">No hay bloques de atenci√≥n para este d√≠a</p>
      </template>
      
      <template x-for="bloque in diaSeleccionado?.bloques" :key="bloque.id">
        <div class="bloque" :class="'bloque-' + bloque.estado">
          <div class="bloque-horario">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"></circle>
              <polyline points="12 6 12 12 16 14"></polyline>
            </svg>
            <span x-text="bloque.hora_inicio + ' - ' + bloque.hora_fin"></span>
          </div>
          
          <div class="bloque-veterinario">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
              <circle cx="12" cy="7" r="4"></circle>
            </svg>
            <span x-text="bloque.veterinario?.nombreCompleto ? 'Dr. ' + bloque.veterinario.nombreCompleto : (bloque.veterinario?.username || 'Sin asignar')"></span>
          </div>
          
          <div class="bloque-estado">
            <span 
              class="estado-badge"
              :class="'estado-' + bloque.estado"
              x-text="obtenerTextoEstado(bloque.estado)"
            ></span>
          </div>
          
          <template x-if="bloque.cita">
            <div class="bloque-paciente">
              üêæ Paciente: <span x-text="bloque.cita.paciente?.nombre || 'N/A'"></span>
            </div>
          </template>
          
          <!-- Bot√≥n Agendar para bloques disponibles -->
          <template x-if="bloque.estado === 'disponible'">
            <div class="bloque-acciones">
              <button @click="abrirAgendar(bloque)" class="px-3 py-1 bg-orange-500 text-white rounded-md">Agendar</button>
            </div>
          </template>
        </div>
      </template>
    </div>
    
    <!-- Modal Agendar -->
    <div x-show="modalAgendarOpen" class="modal-overlay" style="display: none;">
      <div class="modal-content">
        <h4 class="mb-2">Agendar cita - <span x-text="formatearFecha(diaSeleccionado?.fecha)"></span></h4>
        <div class="grid grid-cols-1 gap-2">
          <label class="text-sm">Bloque: <strong x-text="bloqueSeleccionado?.hora_inicio + ' - ' + bloqueSeleccionado?.hora_fin"></strong></label>
          <label class="text-sm">Paciente</label>
          <select x-model="pacienteSeleccionado" class="p-2 border rounded">
            <option value="" disabled selected>Selecciona un paciente</option>
            <template x-for="p in pacientes" :key="p.id">
              <option :value="p.id" x-text="p.nombre"></option>
            </template>
          </select>
          <label class="text-sm">Motivo (opcional)</label>
          <input type="text" x-model="motivoCita" class="p-2 border rounded" />
          <div class="flex gap-2 justify-end mt-2">
            <button @click="cerrarModal()" class="px-3 py-1 bg-gray-200 rounded">Cancelar</button>
            <button @click="confirmarAgendar()" class="px-3 py-1 bg-orange-500 text-white rounded">Confirmar</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // @ts-ignore
  import { obtenerDisponibilidadesPorMes, obtenerPacientes, crearCita, actualizarDisponibilidad, obtenerVeterinarios } from '../../../lib/disponibilidad';
  // @ts-ignore
  import { loadSession } from '../../../lib/authHelpers.js';

  function calendarioDisponibilidad() {
    const hoy = new Date();
    
    return {
      mes: hoy.getMonth() + 1, // 1-12
      anio: hoy.getFullYear(),
      diasMes: [] as any[],
      diasVaciosInicio: 0,
      diaSeleccionado: null as any,
      disponibilidades: [] as any[],
      // Filtro de veterinario
      veterinarios: [] as any[],
      veterinarioSeleccionado: null as number | null,
      // Modal y agendamiento
      modalAgendarOpen: false,
      pacientes: [] as any[],
      pacienteSeleccionado: null,
      motivoCita: '',
      bloqueSeleccionado: null as any,
      
      get nombreMes() {
        const meses = ['Enero', 'Febrero', 'Marzo', 'Abril', 'Mayo', 'Junio',
                       'Julio', 'Agosto', 'Septiembre', 'Octubre', 'Noviembre', 'Diciembre'];
        return meses[this.mes - 1];
      },

      async init() {
        console.log('Inicializando calendario de disponibilidad');
        
        // Esperar un momento para asegurar que loadSession est√© disponible
        await new Promise(resolve => setTimeout(resolve, 100));
        
        // Cargar disponibilidades primero
        await this.cargarDisponibilidades();
        this.generarDiasMes();
        
        // Extraer veterinarios √∫nicos de las disponibilidades
        console.log('Primera disponibilidad completa:', JSON.parse(JSON.stringify(this.disponibilidades[0])));
        
        const veterinariosMap = new Map();
        this.disponibilidades.forEach((disp: any) => {
          console.log('Procesando disponibilidad:', disp.id, 'veterinario:', disp.veterinario);
          
          if (disp.veterinario && disp.veterinario.id) {
            veterinariosMap.set(disp.veterinario.id, {
              id: disp.veterinario.id,
              username: disp.veterinario.username || `Veterinario ${disp.veterinario.id}`,
              nombreCompleto: disp.veterinario.nombreCompleto || null
            });
          }
        });
        
        this.veterinarios = Array.from(veterinariosMap.values()).sort((a, b) => 
          (a.username || '').localeCompare(b.username || '')
        );
        
        console.log('Veterinarios extra√≠dos de disponibilidades:', this.veterinarios);
      },

      async cargarDisponibilidades() {
        console.log(`Cargando disponibilidades para ${this.mes}/${this.anio}`);
        
        try {
          // Usar la funci√≥n importada directamente
          const session = loadSession();
          const jwt = session?.jwt || null;
          
          if (!jwt) {
            console.error('‚ö†Ô∏è No hay JWT disponible - usuario no autenticado');
            console.log('Sesi√≥n completa:', session);
          } else {
            console.log('‚úÖ JWT encontrado, longitud:', jwt.length);
          }
          
          // Cargar disponibilidades (con o sin filtro de veterinario)
          this.disponibilidades = await obtenerDisponibilidadesPorMes(
            this.mes,
            this.anio,
            this.veterinarioSeleccionado, // Filtrar por veterinario si est√° seleccionado
            jwt
          );
          
          console.log('Disponibilidades cargadas:', this.disponibilidades);
        } catch (error) {
          console.error('Error al cargar disponibilidades:', error);
          this.disponibilidades = [];
        }
      },

      generarDiasMes() {
        this.diasMes = [];
        
        // Primer d√≠a del mes (Date usa meses 0-11)
        const primerDia = new Date(this.anio, this.mes - 1, 1);
        const ultimoDia = new Date(this.anio, this.mes, 0);
        const hoyDate = new Date();
        hoyDate.setHours(0, 0, 0, 0);

        // Calcular d√≠as vac√≠os al inicio (lunes = 1, domingo = 0)
        let diaSemana = primerDia.getDay();
        this.diasVaciosInicio = diaSemana === 0 ? 6 : diaSemana - 1;

        // Generar d√≠as del mes
        for (let dia = 1; dia <= ultimoDia.getDate(); dia++) {
          const fecha = new Date(this.anio, this.mes - 1, dia);
          const fechaStr = this.formatearFechaISO(fecha);
          
          // Obtener disponibilidades para este d√≠a
          const disponibilidadesDia = this.disponibilidades.filter(
            (d: any) => d.fecha === fechaStr
          );
          
          // Debug: log para ver estructura de datos
          if (disponibilidadesDia.length > 0 && dia <= 2) {
            console.log(`Disponibilidad del d√≠a ${dia}:`, JSON.parse(JSON.stringify(disponibilidadesDia[0])));
          }
          
          const cantidadDisponible = disponibilidadesDia.filter(
            (d: any) => d.estado === 'disponible'
          ).length;
          
          const cantidadOcupado = disponibilidadesDia.filter(
            (d: any) => d.estado === 'ocupado'
          ).length;
          
          fecha.setHours(0, 0, 0, 0);
          
          this.diasMes.push({
            numero: dia,
            fecha: fechaStr,
            esHoy: fecha.getTime() === hoyDate.getTime(),
            esPasado: fecha < hoyDate,
            tieneDisponibilidad: disponibilidadesDia.length > 0,
            cantidadDisponible,
            cantidadOcupado,
            bloques: disponibilidadesDia,
          });
        }
      },

      async mesAnterior() {
        if (this.mes === 1) {
          this.mes = 12;
          this.anio--;
        } else {
          this.mes--;
        }
        await this.cargarDisponibilidades();
        this.generarDiasMes();
        this.diaSeleccionado = null;
      },

      async mesSiguiente() {
        if (this.mes === 12) {
          this.mes = 1;
          this.anio++;
        } else {
          this.mes++;
        }
        await this.cargarDisponibilidades();
        this.generarDiasMes();
        this.diaSeleccionado = null;
      },

      seleccionarDia(dia: any) {
        if (dia.esPasado) {
          console.log('No se puede seleccionar un d√≠a pasado');
          return;
        }
        
        if (!dia.tieneDisponibilidad) {
          console.log('No hay disponibilidad para este d√≠a');
          return;
        }
        
        this.diaSeleccionado = dia;
        console.log('D√≠a seleccionado:', dia);
      },

      async abrirAgendar(bloque: any) {
        // Solo bloques disponibles
        if (bloque.estado !== 'disponible') return;
        this.bloqueSeleccionado = bloque;
        this.motivoCita = '';
        this.pacienteSeleccionado = null;
        this.modalAgendarOpen = true;

        if (!this.pacientes || this.pacientes.length === 0) {
          try {
            const session = loadSession();
            const jwt = session?.jwt || null;
            this.pacientes = await obtenerPacientes(jwt);
          } catch (err) {
            console.error('Error cargando pacientes:', err);
            this.pacientes = [];
          }
        }
      },

      cerrarModal() {
        this.modalAgendarOpen = false;
        this.bloqueSeleccionado = null;
      },

      async confirmarAgendar() {
        if (!this.bloqueSeleccionado || !this.diaSeleccionado) return;
        if (!this.pacienteSeleccionado) { alert('Selecciona un paciente'); return; }

        try {
          const session = loadSession();
          const jwt = session?.jwt || null;
          const recepcionistaId = session?.appUser?.profile?.id || null;

          // Crear cita
          const cita = await crearCita({
            fecha: this.diaSeleccionado.fecha,
            hora: this.bloqueSeleccionado.hora_inicio,
            motivo: this.motivoCita,
            pacienteId: this.pacienteSeleccionado,
            veterinarioId: this.bloqueSeleccionado.veterinario?.id || null,
            recepcionistaId,
            disponibilidadId: this.bloqueSeleccionado.id,
            jwt,
          });

          console.log('Cita creada:', cita);

          // Actualizar disponibilidad a ocupado (usar documentId)
          const docId = this.bloqueSeleccionado.documentId || this.bloqueSeleccionado._documentId || null;
          if (docId) {
            await actualizarDisponibilidad(docId, { estado: 'ocupado', disponible: false, cita: cita.id }, jwt);
          }

          // Recargar
          await this.cargarDisponibilidades();
          this.generarDiasMes();
          this.cerrarModal();
          this.diaSeleccionado = null;
          alert('Cita agendada correctamente');
        } catch (err: unknown) {
          console.error('Error agendando cita:', err);
          const errorMessage = err instanceof Error ? err.message : 'Error al agendar cita';
          alert(errorMessage);
        }
      },

      cerrarDetalle() {
        this.diaSeleccionado = null;
      },

      formatearFecha(fechaISO: string) {
        if (!fechaISO) return '';
        
        const fecha = new Date(fechaISO + 'T00:00:00');
        const opciones: Intl.DateTimeFormatOptions = { 
          weekday: 'long', 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        };
        
        return fecha.toLocaleDateString('es-ES', opciones);
      },

      formatearFechaISO(fecha: Date) {
        const anio = fecha.getFullYear();
        const mes = String(fecha.getMonth() + 1).padStart(2, '0');
        const dia = String(fecha.getDate()).padStart(2, '0');
        return `${anio}-${mes}-${dia}`;
      },

      obtenerTextoEstado(estado: string) {
        const estados: Record<string, string> = {
          'disponible': '‚úì Disponible',
          'ocupado': '‚úó Ocupado',
          'bloqueado': '‚äò Bloqueado',
        };
        return estados[estado] || estado;
      },

      getClass(dia: any) {
        let clases = '';
        if (dia.esPasado || !dia.tieneDisponibilidad) {
          clases += 'dia-sin-disponibilidad ';
        }
        if (dia.esHoy && dia.tieneDisponibilidad && !dia.esPasado) clases += 'dia-hoy ';
        if (dia.tieneDisponibilidad && !dia.esPasado) clases += 'dia-con-disponibilidad ';
        if (this.diaSeleccionado && this.diaSeleccionado.fecha === dia.fecha) clases += 'dia-seleccionado';
        return clases.trim();
      },

      async onChangeVeterinario() {
        console.log('Filtrando por veterinario:', this.veterinarioSeleccionado);
        await this.cargarDisponibilidades();
        this.generarDiasMes();
        this.diaSeleccionado = null;
      },
    }
  }

  (window as any).calendarioDisponibilidad = calendarioDisponibilidad;
</script>

<style>
  .calendario-container {
    max-width: 100%;
    padding: 1rem;
    background: white;
    border-radius: 1rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
    border: 1px solid #f3f4f6;
  }

  .calendario-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 2px solid #e5e7eb;
  }

  .mes-titulo {
    font-size: 1.25rem;
    font-weight: 700;
    color: #1f2937;
    margin: 0;
  }

  .btn-nav {
    padding: 0.5rem;
    background: #FF8119;
    color: white;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s;
  }

  .btn-nav:hover {
    background: #e57310;
    transform: scale(1.05);
  }

  .calendario-dias-semana {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 0.375rem;
    margin-bottom: 0.375rem;
    font-weight: 600;
    text-align: center;
    color: #6b7280;
    font-size: 0.75rem;
  }

  .calendario-dias {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 0.375rem;
    margin-bottom: 1rem;
  }

  .dia-vacio {
    aspect-ratio: 1;
  }

  .dia {
    aspect-ratio: 1;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    border: 2px solid #e5e7eb;
    border-radius: 8px;
    transition: all 0.2s;
    position: relative;
    padding: 0.25rem;
    background: white;
  }

  .dia-sin-disponibilidad {
    opacity: 0.4;
    cursor: not-allowed;
    background: #f9fafb;
    color: #9ca3af;
  }

  .dia:hover:not(.dia-sin-disponibilidad) {
    background: #f0fdf4;
    border-color: #22c55e;
    transform: translateY(-2px);
    box-shadow: 0 2px 4px rgba(34, 197, 94, 0.2);
    cursor: pointer;
  }

  .dia-hoy {
    background: #dbeafe;
    font-weight: 700;
  }

  .dia-hoy.dia-con-disponibilidad {
    border-color: #22c55e;
    border-width: 2px;
  }

  .dia-con-disponibilidad {
    border-color: #22c55e;
    border-width: 2px;
    background: white;
    cursor: pointer;
  }

  .dia-seleccionado {
    border-color: #FF8119 !important;
    background: #FFF5EB !important;
    box-shadow: 0 0 0 3px rgba(255, 129, 25, 0.2);
  }

  .numero-dia {
    font-size: 0.8rem;
    font-weight: 600;
    margin-bottom: 0.125rem;
  }

  .indicadores {
    display: flex;
    gap: 0.125rem;
    flex-wrap: wrap;
    justify-content: center;
  }

  .badge {
    font-size: 0.55rem;
    padding: 0.0625rem 0.25rem;
    border-radius: 9999px;
    font-weight: 600;
    line-height: 1;
  }

  .badge-disponible {
    background: #22c55e;
    color: white;
  }

  .badge-ocupado {
    background: #ef4444;
    color: white;
  }

  /* Info del d√≠a seleccionado */
  .info-dia {
    background: #f9fafb;
    border-radius: 12px;
    padding: 1.5rem;
    border: 2px solid #e5e7eb;
  }

  .info-dia-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 1rem;
    padding-bottom: 0.75rem;
    border-bottom: 1px solid #d1d5db;
  }

  .info-dia-header h4 {
    margin: 0;
    font-size: 1.125rem;
    color: #1f2937;
    font-weight: 600;
  }

  .btn-cerrar {
    background: none;
    border: none;
    font-size: 1.5rem;
    color: #6b7280;
    cursor: pointer;
    width: 32px;
    height: 32px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 4px;
    transition: all 0.2s;
  }

  .btn-cerrar:hover {
    background: #e5e7eb;
    color: #1f2937;
  }

  .sin-bloques {
    text-align: center;
    color: #6b7280;
    padding: 2rem;
    font-style: italic;
  }

  .bloques-container {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
  }

  .bloque {
    background: white;
    border-radius: 8px;
    padding: 1rem;
    border-left: 4px solid #d1d5db;
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    transition: all 0.2s;
  }

  .bloque:hover {
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  }

  .bloque-disponible {
    border-left-color: #22c55e;
    background: #f0fdf4;
  }

  .bloque-ocupado {
    border-left-color: #ef4444;
    background: #fef2f2;
  }

  .bloque-bloqueado {
    border-left-color: #6b7280;
    background: #f9fafb;
  }

  .bloque-horario,
  .bloque-veterinario,
  .bloque-paciente {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.875rem;
    color: #374151;
  }

  .bloque-acciones { margin-top: 0.5rem; }

  /* Modal agendar */
  .modal-overlay {
    position: fixed;
    inset: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    background: rgba(0,0,0,0.45);
    z-index: 60;
    padding: 1rem;
  }

  .modal-content {
    background: white;
    padding: 1rem 1.25rem;
    border-radius: 8px;
    width: 100%;
    max-width: 520px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.2);
  }

  .bloque-estado {
    margin-top: 0.25rem;
  }

  .estado-badge {
    display: inline-block;
    padding: 0.25rem 0.75rem;
    border-radius: 9999px;
    font-size: 0.75rem;
    font-weight: 600;
  }

  .estado-disponible {
    background: #dcfce7;
    color: #166534;
  }

  .estado-ocupado {
    background: #fee2e2;
    color: #991b1b;
  }

  .estado-bloqueado {
    background: #f3f4f6;
    color: #374151;
  }

  /* Responsive */
  @media (max-width: 640px) {
    .calendario-container {
      padding: 1rem;
    }

    .mes-titulo {
      font-size: 1.25rem;
    }

    .dia {
      padding: 0.125rem;
    }

    .numero-dia {
      font-size: 0.75rem;
    }

    .badge {
      font-size: 0.5rem;
      padding: 0.0625rem 0.25rem;
    }
  }
</style>

---
---

<div class="mis-citas-container manrope" x-data="misCitas()">
  <!-- Header -->
  <div class="mb-6">
    <h2 class="text-2xl font-bold text-gray-900 mb-2">Mis Citas</h2>
    <p class="text-gray-600">Revisa el estado de tus citas veterinarias</p>
  </div>

  <!-- Filtros por estado -->
  <div class="flex gap-3 mb-6 flex-wrap">
    <button 
      @click="filtroEstado = 'todas'"
      :class="filtroEstado === 'todas' ? 'bg-orange-500 text-white' : 'bg-white text-gray-700 border border-gray-300'"
      class="px-4 py-2 rounded-lg font-medium transition-all"
    >
      Todas (<span x-text="citas.length"></span>)
    </button>
    <button 
      @click="filtroEstado = 'pendiente'"
      :class="filtroEstado === 'pendiente' ? 'bg-yellow-500 text-white' : 'bg-white text-gray-700 border border-gray-300'"
      class="px-4 py-2 rounded-lg font-medium transition-all"
    >
      Pendientes (<span x-text="citasPorEstado.pendiente"></span>)
    </button>
    <button 
      @click="filtroEstado = 'confirmada'"
      :class="filtroEstado === 'confirmada' ? 'bg-green-500 text-white' : 'bg-white text-gray-700 border border-gray-300'"
      class="px-4 py-2 rounded-lg font-medium transition-all"
    >
      Confirmadas (<span x-text="citasPorEstado.confirmada"></span>)
    </button>
    <button 
      @click="filtroEstado = 'cancelada'"
      :class="filtroEstado === 'cancelada' ? 'bg-red-500 text-white' : 'bg-white text-gray-700 border border-gray-300'"
      class="px-4 py-2 rounded-lg font-medium transition-all"
    >
      Canceladas (<span x-text="citasPorEstado.cancelada"></span>)
    </button>
  </div>

  <!-- Lista de citas -->
  <div class="space-y-4">
    <template x-if="cargando">
      <div class="text-center py-8">
        <p class="text-gray-500">Cargando citas...</p>
      </div>
    </template>

    <template x-if="!cargando && citasFiltradas.length === 0">
      <div class="bg-gray-50 rounded-lg p-8 text-center">
        <p class="text-gray-500">No tienes citas <span x-text="filtroEstado === 'todas' ? '' : 'en estado: ' + filtroEstado"></span></p>
      </div>
    </template>

    <template x-for="cita in citasFiltradas" :key="cita.id">
      <div class="bg-white rounded-xl shadow-md border-l-4 p-5 transition-all hover:shadow-lg"
           :class="{
             'border-yellow-500': cita.estado === 'pendiente',
             'border-green-500': cita.estado === 'confirmada',
             'border-red-500': cita.estado === 'cancelada',
             'border-blue-500': cita.estado === 'atendida'
           }">
        
        <div class="flex justify-between items-start mb-3">
          <div>
            <h3 class="font-semibold text-lg text-gray-900" x-text="'Dr. ' + (cita.veterinario?.nombreCompleto || 'N/A')"></h3>
            <p class="text-sm text-gray-600" x-text="formatearFecha(cita.fecha) + ' - ' + cita.hora"></p>
          </div>
          <span 
            class="px-3 py-1 rounded-full text-xs font-semibold"
            :class="{
              'bg-yellow-100 text-yellow-800': cita.estado === 'pendiente',
              'bg-green-100 text-green-800': cita.estado === 'confirmada',
              'bg-red-100 text-red-800': cita.estado === 'cancelada',
              'bg-blue-100 text-blue-800': cita.estado === 'atendida'
            }"
            x-text="cita.estado.toUpperCase()"
          ></span>
        </div>

        <div class="space-y-1 text-sm">
          <p class="text-gray-700"><strong>Mascota:</strong> <span x-text="cita.paciente?.nombre || 'N/A'"></span></p>
          <p class="text-gray-700" x-show="cita.motivo"><strong>Motivo:</strong> <span x-text="cita.motivo"></span></p>
        </div>

        <!-- Mensaje según estado -->
        <div class="mt-3 text-sm" x-show="cita.estado === 'pendiente'">
          <p class="text-yellow-700 bg-yellow-50 p-2 rounded">⏳ Esperando confirmación del recepcionista</p>
        </div>
        <div class="mt-3 text-sm" x-show="cita.estado === 'confirmada'">
          <p class="text-green-700 bg-green-50 p-2 rounded">✓ Cita confirmada - Asiste puntualmente</p>
        </div>
        <div class="mt-3 text-sm" x-show="cita.estado === 'cancelada'">
          <p class="text-red-700 bg-red-50 p-2 rounded">✗ Esta cita fue cancelada</p>
        </div>
      </div>
    </template>
  </div>
</div>

<script>
  // @ts-ignore
  import { obtenerCitas } from '../../../lib/disponibilidad';
  // @ts-ignore
  import { loadSession } from '../../../lib/authHelpers.js';

  function misCitas() {
    return {
      citas: [] as any[],
      cargando: true,
      filtroEstado: 'todas' as string,

      get citasFiltradas() {
        if (this.filtroEstado === 'todas') {
          return this.citas;
        }
        return this.citas.filter((c: any) => c.estado === this.filtroEstado);
      },

      get citasPorEstado() {
        return {
          pendiente: this.citas.filter((c: any) => c.estado === 'pendiente').length,
          confirmada: this.citas.filter((c: any) => c.estado === 'confirmada').length,
          cancelada: this.citas.filter((c: any) => c.estado === 'cancelada').length,
          atendida: this.citas.filter((c: any) => c.estado === 'atendida').length,
        };
      },

      async init() {
        await this.cargarCitas();
      },

      async cargarCitas() {
        try {
          this.cargando = true;
          const session = loadSession();
          const jwt = session?.jwt || null;

          console.log('=== CARGANDO MIS CITAS (CLIENTE) ===');

          if (!jwt) {
            console.error('No hay sesión activa');
            alert('No hay sesión activa. Por favor inicia sesión.');
            return;
          }

          this.citas = await obtenerCitas(jwt);
          console.log('✅ Mis citas cargadas:', this.citas.length, 'citas');
          console.log('Por estado:', this.citasPorEstado);
        } catch (error) {
          console.error('❌ Error cargando citas:', error);
          alert('Error al cargar las citas: ' + (error instanceof Error ? error.message : 'Error desconocido'));
        } finally {
          this.cargando = false;
        }
      },

      formatearFecha(fechaISO: string) {
        if (!fechaISO) return '';
        const fecha = new Date(fechaISO + 'T00:00:00');
        const opciones: Intl.DateTimeFormatOptions = { 
          weekday: 'long', 
          year: 'numeric', 
          month: 'long', 
          day: 'numeric' 
        };
        return fecha.toLocaleDateString('es-ES', opciones);
      },
    };
  }
</script>
